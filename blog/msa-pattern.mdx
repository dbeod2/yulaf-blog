---
title: "마이크로서비스 패턴"
date: "2024-10-05"
slug: "msa-pattern"
---

마이크로서비스 패턴 책을 읽고 정리한 내용이다. 
계속 읽는중이고 업데이트 할 예정이다. 


# 마이크로서비스 아키텍처란 무엇인가? 
마이크로서비스 아키텍처의 핵심 사상은 기능 분해라고한다. 

대규모 단일 애플리케이션을 개발하는 대신 애플리케이션을 여러 서비스로 구성하자는 것! 

## 소프트웨어 아키텍처의 정의

컴퓨팅 시스템의 소프트웨어 아키텍처는 소프트웨어 엘리먼트와 그들간의 관계 그리고 이 둘의 속성으로 구성된 시스템을 추론하는데 필요한 구조의 집합이다. 라고 정의했다고 한다. (렌바그와 그가 이끄는 공학연구소에서)

핵심만 말하자면 **애플리케이션 아키텍처가 여러 파트(엘리먼트) 분해와 이런 파트간의 관계(연관성)**라는 것이다 

분해가 중요한 이유는 아래 두 가지때문이다

1. 업무와 지식을 분리한다. 
2. 소프트웨어 엘리먼트가 어떻게 상호 작용하는지 밝힌다. 

## 아키텍처의 중요성

성능, 확장성, 유지보수성, 보안 등 서비스 품질 요건을 충족시킬 수 있게 설계해야하므로 아키텍처는 정말 중요하다.

### 육각형 아키텍처 스타일

논리 뷰를 비즈니스 로직 중심으로 구성하는 계층화 아키텍처 스타일의 대안이다. 

- 계층화 아키텍처는 소프트웨어 엘리먼트를 계층별로 구성하는 전형적인 아키텍처라고 보면된다.

특징으로는 비즈니스 로직이 어댑터에 전혀 의존하지 않는다는 것이다. 

육각형 아키텍처는 포트와 어댑터 패턴이라고도 불린다. 

**포트는 비즈니스 로직이 외부와 상호 작용하는 방법이 정의된 작업, 즉 인터페이스이다.** 

인바운드와 아웃바운드로 나뉜다.

인바운드 포트는 비즈니스 로직이 표출된 API로서, 외부 애플리케이션은 이 API를 이 API를 통해 비즈니스 로직을 호출한다.

아웃바운트 포트는 비즈니스 로직이 외부 시스템을 호출하는 방법에 관한것이다.

**어댑터는 비즈니스 로직을 감싸고 있다. 어댑터 또한 인바운드/아웃바운드로 나뉜다.** 

인바운드 어댑터는 외부에서 들어온 요청을 인바운트 포트를 호출해서 처리한다. 

아웃바운드 어댑터는 비즈니스 로직에서 들어온 요청을 외부 애플리케이션/서비스를 호출해서 처리한다. 즉 db나 외부 api서비스 호출시 프록스 역할을 한다.

## 서비스란 무엇인가?

서비스는 어떤 기능이 구현되어 단독 배포가 가능한 소프트웨어 컴포넌트다. 

또한 클라이언트가 자신이 서비스하는 기능에 접근할 수있도록 커맨트, 쿼리, 이벤트로 구성된 API를 제공한다. 

### 느슨한 결합

*마이크로서비스 아키텍처의 핵심 제약 조건은 서비스를 느슨하게 결합한다는 것이다.

구현 코드를 감싼 API를 통해서만 상호 작용하므로 클라이언트에 영향을 끼치지 않고 서비스 내부 구현 코드를 바꿀 수있다. 

느슨하게 결합된 서비스는 유지보수성, 테스트성을 높이고 애플리케이션 개발 시간을 단축하는데 효과가 있다. 

## 마이크로서비스 아키텍처 정의

### 1. 시스템 작업 식별

사용자 스토리와 이와 연관된 사용자 시나리오 등의 애플리케이션 요건이다.

### 2. 서비스 정의: 비즈니스 능력 패턴별 분해

마이크로서비스 아키텍처를 구축하는 첫 번째 전략은 비즈니스 능력에 따라 분해하는 것이다. 

아키텍처 모델링에서 비롯된 비즈니스 능력은 비즈니스가 가치를 생성하기 위해 하는 일을 말한다. 

**비즈니스 능력을 식별한 후 연관된 능력 그룹에 따라 서비스를 정의하는 것이다.** 

### 3. 서비스 정의: 하위 도메인 패턴별 분해

도메인 내부에서 문제 해결이 가능한 형태로 도메인을 모델링하는 기법을 말한다.

DDD는 팀에서 사용할 공용 언어(유비쿼터스 언어)를 정의한다. DDD에는 마이크로서비스 아키텍처에 적용하면 정말 유용한 하위 도메인 (서브 도메인)과 경계 컨텍스트(바운디드 컨테스트) 개념이 있다.

도메인 모델의 범위를 DDD 용어로는 경계 컨텍스트(바운디드 컨텍스트)라고 한다. 경계 컨텍스트는 도메인 모델을 구현한 코드 아티팩트를 포홤하며, 마이크로서비스 아키텍처에 DDD를 적용하면 각 서비스가 경계 컨텍스트가 된다.

### 4. 분해 지침

비즈니스 능력에 따른 분해, 하위 도메인에 따른 분해는 마이크로서비스 아키텍처를 정의하는 주요한 수단이다. 

분해 과정에는 장애물이 많다. 

- 네트워크 지원
    - 서비스를 여러 개로 나누면 서비스간 왕복 횟수가 급증하고 성능이 떨어진다.
    - 이를 해결하기 위해 한 차례 왕복으로 여러 객체를 한 번에 가져오는 배치API를 구현하거나, 값비싼 IPC를 언어 수준의 메서드나 함수 호출로 대체하는 식으로 서비스 결합에 따른 지연 시간을 줄인다.
- 동기 통신으로 인해 가용성 저하
    - 서비스간 통신이 강한 결합도로 인해 가용성이 떨어진다.
    - 비동기 메시징으로 강한 결합도를 제거하고 가용성을 높이는 방법이 더 좋다.
- 여러 서비스에 걸쳐 데이터 일관성 유지
    - 여러 서비스에 걸쳐 데이터 일관성을 유지하는 일도 쉽지는 않다.
    - 과거에는 커밋 방식의 2단계 분산 트랜잭션을 많이 썼지만, 요즘 애플리케이션에는 잘 안맞기 때문에 사가라는 전혀 다른 방식으로 트랜잭션을 관리한다.
    - 사가는 메시징을 이용한 일련의 로컬트랜잭션이며, 기존 ACID 보다는 복잡하지만 다양한 상황에서도 잘 동작한다. 단, 한가지 단점은 최종 일관성을 보장한다는 것이다.
- 데이터의 일관된 뷰 확보
    - 모놀리식 애플리케이션에서는 ACID의 속성 덕분에 어떻게 쿼리를 하든 일관된 데이터 뷰가 반환되었지만 마이크로서비스 아키텍처는 각 서비스의 db가 일관적이라해도 전역 범위에서 일관된 데이터 뷰를 확보할 수없다.
    - 다행히 실제로 이것은 거의 문제가 되지않는다.
- 분해를 저해하는 만능 클래스
    - 만능 클래스는 너무 많은 책임을 한 클래스에 몰아 넣은것이다. 그래서 존재만으로도 분해의 걸림돌이 된다고한다.
    - 이런 클래스의 경우 DDD를 적용해 각 서비스를 자체 도메인 모델을 갖고 있는 개별 하위 도메인으로 취급하는 것이 좋은 방법이다.